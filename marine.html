<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Realtime Marine Data</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        /* Styles for blue popup */
        .mapboxgl-popup {
            max-width: 250px;
            border-radius: 10px;
        }

        .mapboxgl-popup-content {
            color: #FEFFD6;
            background: #55688f;
        }

        .mapboxgl-popup-tip {
            border-top-color: #55688f;
        }

        .mapboxgl-popup-anchor-bottom .mapboxgl-popup-tip {
            border-top-color: #55688f;
        }

        .mapboxgl-popup-anchor-top .mapboxgl-popup-tip {
            border-bottom-color: #55688f;
        }

        .mapboxgl-popup-anchor-left .mapboxgl-popup-tip {
            border-right-color: #55688f;
        }

        .mapboxgl-popup-anchor-right .mapboxgl-popup-tip {
            border-left-color: #55688f;
        }

        .mapboxgl-popup-anchor-top-left .mapboxgl-popup-tip {
            border-bottom-color: #55688f;
        }

        .mapboxgl-popup-anchor-top-right .mapboxgl-popup-tip {
            border-bottom-color: #55688f;
        }

        .mapboxgl-popup-anchor-bottom-left .mapboxgl-popup-tip {
            border-top-color: #55688f;
        }

        .mapboxgl-popup-anchor-bottom-right .mapboxgl-popup-tip {
            border-top-color: #55688f;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiZ3JhZmEiLCJhIjoiY2ptYjNtZWxnMDBrdDNwbnVicGJzOWg2NyJ9.9OulyCe3kEqMAXPbx1mKUA';
        const map = new mapboxgl.Map({
            container: 'map',
            // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
            style: 'mapbox://styles/grafa/clv43t0pc00fw01q1gjy7bs9r',
            zoom: 2.5,
            center: [-63.29382117050238, 12.998746575435348]
        });

        map.on('load', async () => {
            // Get the initial location of the International Space Station (ISS).
            const geojson = await getLocation();
            console.log(geojson);
            // Add the marine animals location as a source.
            map.addSource('marine', {
                type: 'geojson',
                data: geojson
            });
            // Add the shark symbol layer to the map.
            map.addLayer({
                'id': 'marine',
                'type': 'symbol',
                'source': 'marine',
                'layout': {
                    'icon-image': 'shark',
                    'icon-size': 0.25
                }
            });

            // Update the source from the API every 100 seconds.
            const updateSource = setInterval(async () => {
                const geojson = await getLocation(updateSource);
                map.getSource('marine').setData(geojson);
            }, 100000);

            async function getLocation(updateSource) {
                // Make a GET request to the API and return the location of the ISS.
                try {
                    const response = await fetch(
                        'https://www.mapotic.com/api/v1/maps/3413/pois.geojson/',
                        { method: 'GET' }
                    );
                    const features = await response.json();
                    // Fly the map to the location.
                    // map.flyTo({
                    //     center: [longitude, latitude],
                    //     speed: 0.5
                    // });
                    // Return the location of the ISS as GeoJSON.
                    return features;
                } catch (err) {
                    // If the updateSource interval is defined, clear the interval to stop updating the source.
                    if (updateSource) clearInterval(updateSource);
                    throw new Error(err);
                }
            }
            // when the marine layer is clicked, open a popup at the location of the click, with description HTML from its properties.
            // add the following properties:
            // category
            // category_name
            // gender
            // id
            // image
            // image_data
            // is_published
            // last_move_datetime
            // last_update
            // length
            // name
            // slug
            // species
            // stage_of_life
            // tag_location
            // weight
            // zping
            // zping_datetime
            let popup = new mapboxgl.Popup({
                closeButton: false,
                closeOnClick: true
            });

            map.on('click', 'marine', function (e) {
                console.log(e.features[0].properties);
                popup.setLngLat(e.lngLat)
                    .setHTML('<h3>' + e.features[0].properties.name + '</h3>' +
                        e.features[0].properties.species + '<br>' +
                        e.features[0].properties.stage_of_life + '<br>' +
                        e.features[0].properties.weight + '<br>' +
                        e.features[0].properties.length + '<br>' +
                        '<img src=' + e.features[0].properties.image + ' width="200px"/>')
                    .addTo(map);
            });
            // close the popup when the mouse leaves the marine layer.
            map.on('mouseleave', 'marine', function () {
                map.getCanvas().style.cursor = '';
                popup.remove();
            });

        });
    </script>

</body>

</html>