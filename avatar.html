<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Add model to map</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<!-- include bootstrap.min.css -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

<link href="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js"></script>
<style>
body { margin: 0; padding: 0; }
#map { position: absolute; top: 0; bottom: 0; width: 100%; }
</style>
</head>
<body>
<style>
    .map-overlay {
        font:
            12px/20px 'Helvetica Neue',
            Arial,
            Helvetica,
            sans-serif;
        position: absolute;
        width: 240px;
        top: 0;
        left: 0;
        padding: 10px;
    }

    .map-overlay .map-overlay-inner {
        background-color: #fff;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        border-radius: 3px;
        padding: 10px;
        margin-bottom: 10px;
    }

    .map-overlay-inner fieldset {
        display: flex;
        justify-content: space-between;
        border: none;
    }

    .map-overlay-inner label {
        font-weight: bold;
        margin-right: 10px;
    }

    .map-overlay-inner .select-fieldset {
        display: block;
    }

    .map-overlay-inner .select-fieldset label {
        display: block;
        margin-bottom: 5px;
    }

    .map-overlay-inner .select-fieldset select {
        width: 100%;
    }
</style>

<div id="map"></div>

<div class="map-overlay top">
    <div class="map-overlay-inner">
        <fieldset class="select-fieldset">
            <h4><label>Select light preset</label></h4>
            <select id="lightPreset" name="lightPreset">
                <!-- Each value matches a light preset -->
                <option value="dawn">Dawn</option>
                <option value="day" selected="">Day</option>
                <option value="dusk">Dusk</option>
                <option value="night">Night</option>
            </select>
        </fieldset>
        <fieldset>
            <label for="showPlaceLabels">Show place labels</label>
            <input type="checkbox" id="showPlaceLabels" checked="">
        </fieldset>
        <fieldset>
            <label for="showPointOfInterestLabels">Show POI labels</label>
            <input type="checkbox" id="showPointOfInterestLabels" checked="">
        </fieldset>
        <fieldset>
            <label for="showRoadLabels">Show road labels</label>
            <input type="checkbox" id="showRoadLabels" checked="">
        </fieldset>
        <fieldset>
            <label for="showTransitLabels">Show transit labels</label>
            <input type="checkbox" id="showTransitLabels" checked="">
        </fieldset>
        <button id="rotate" onclick="rotateModel()" class="btn btn-success">Move around</button>

    </div>
</div>

<script>
	mapboxgl.accessToken = 'pk.eyJ1IjoiZ3JhZmEiLCJhIjoiY2ptYjNtZWxnMDBrdDNwbnVicGJzOWg2NyJ9.9OulyCe3kEqMAXPbx1mKUA';
    const map = new mapboxgl.Map({
        container: 'map', // container ID
        center: [2.2950397535774414,48.85720928643093], // starting position [lng, lat]
        zoom: 16.1, // starting zoom
        pitch: 62, // starting pitch
        bearing: -200 // starting bearing
    });

    map.on('style.load', () => {
        document
            .getElementById('lightPreset')
            .addEventListener('change', function () {
                map.setConfigProperty('basemap', 'lightPreset', this.value);
            });

        document
            .querySelectorAll('.map-overlay-inner input[type="checkbox"]')
            .forEach((checkbox) => {
                checkbox.addEventListener('change', function () {
                    map.setConfigProperty('basemap', this.id, this.checked);
                });
            });
            map.addSource("mysource", {
            type: "geojson",
            data: {
                type: "FeatureCollection",
                features: [
                    {
                        type: "Feature",
                        id: "fc842f12-071f-5537-a665-bace79d0d5b3",
                        geometry: {
                            coordinates: [2.2963844880474937,48.857116722166865],
                            type: "Point",
                        },
                        properties: {},
                    },
                ],
            },
        });

        // I see that a network request is made to this URL.
        map.addModel("avatar", "body.glb");

        // No models show up on the map. No errors are thrown. What's missing?
        map.addLayer({
            id: "modellayer",
            type: "model",
            source: "mysource",
            layout: {
                "model-id": "avatar",
            },
            paint: {
                "model-scale": [100, 100, 100],
                "model-rotation": [0, 0, 180],
                "model-translation": [0, 0, 0]
            },
        });
        map.getLayer("modellayer").scope = "";
    });

    // create a function that will rotate the model 90 degrees each time the button is pressed
    function rotateModel() {
        const turn = Math.random() * 360;
        const step = Math.random() * 100;
        const rotation = map.getPaintProperty("modellayer", "model-rotation");
        const translation = map.getPaintProperty("modellayer", "model-translation");
        map
            .setPaintProperty("modellayer", 
                "model-rotation", [
                    rotation[0],
                    rotation[1],
                    rotation[2] + turn,
                ])
            .setPaintProperty("modellayer", 
                "model-translation", [
                    translation[0],
                    translation[1] + step,
                    translation[2],
                ]
        );
    };

    // using the FreeCamera API, we can set the camera's bearing, pitch, and position in order to create a fly-to effect that will move the camera around the model in a circle
    map.on('load', () => {
        const camera = map.getFreeCameraOptions();
        const center = map.getCenter();
        const radius = 0.005;
        const bearing = 0;
        const pitch = 60;
        const speed = 0.5;
        const curve = 1;
        const easing = (t) => {
            return t * (2 - t);
        };
        const step = 0.01;
        let angle = 0;
        let t = 0;
        let interval = null;

        document.getElementById('rotate').addEventListener('click', () => {
            if (interval) {
                clearInterval(interval);
                interval = null;
            } else {
                interval = setInterval(() => {
                    angle += step;
                    t += step;
                    if (t > 1) {
                        t = 0;
                    }
                    const x = center.lng + Math.cos(angle) * radius;
                    const y = center.lat + Math.sin(angle) * radius;
                    map.flyTo({
                        center: [x, y],
                        bearing,
                        pitch,
                        speed,
                        curve,
                        easing,
                    });
                }, 100);
            }
        });
    });

    </script>

</body>
</html>