<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>The Lead Toolbox</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v3.9.3/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.9.3/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.min.js"></script>
    <link
      rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.css"
      type="text/css"
    />
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, Helvetica, sans-serif;
      }
      #map {
        width: 100%;
        height: 600px;
      }
      /* add target image to center of map div */
      .custom-marker {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23000000' width='24px' height='24px'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z'/%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3C/svg%3E");
        background-size: 24px 24px;
        background-repeat: no-repeat;
        background-position: center;
        transform: translate(-50%, -50%);
        background-color: rgba(255, 0, 0, 0.411);
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
      }
      /* add a div to hold the input field */
      #coord-input-container {
        display: flex;
        justify-content: center;
        margin-top: 10px;
        align-items: center;
        z-index: 10;
      }
      #gps-coords {
        background-color: #e9e9e9;
        color: #acacac;
        font-size: 1em;
        border: none;
        width: 70%;
      }

      /* user legend */
      #legend {
        position: absolute;
        bottom: 40px;
        left: 10px;
        z-index: 1;
        background-color: white;
        padding: 10px;
        border-radius: 10px;
        width: 260px;
        max-width: 240px;
      }
      .opportunities {
        list-style-type: none;
        padding: 0;
      }
      .opportunities li {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }
      .opportunities li label {
        margin-right: 10px;
      }
      /* The switch - the box around the slider */
      .switch {
        position: relative;
        display: inline-block;
        width: 49px;
        height: 20px;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 15px;
        width: 15px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
      }
      input:checked + .slider:before {
        -webkit-transform: translateX(28px);
        -ms-transform: translateX(28px);
        transform: translateX(28px);
      }
      /* Rounded sliders */
      .slider.round {
        border-radius: 34px;
      }
      .slider.round:before {
        border-radius: 50%;
      }
      /* add contact */
      .add-contact-container {
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      /* create a horizontal line that is grey and 80% width in the container */
      hr {
        border: 0;
        border-top: 1px solid #ccc;
        width: 80%;
        margin: 10px auto;
        border-color: #5d5d5d;
      }
      .add-contact-container img {
        margin-right: 10px;
      }
      /* popup styles */
      .mapboxgl-popup {
        max-width: 200px;
        font: 12px/20px "Helvetica Neue", Arial, Helvetica, sans-serif;
      }
      .mapboxgl-popup h3 {
        /* background-color: #3498db; */
        color: #000;
        margin: 0;
        display: block;
        padding: 10px;
        border-radius: 3px 3px 0 0;
        font-weight: 700;
      }
      .mapboxgl-popup-content {
        padding: 10px;
        border-radius: 0 0 3px 3px;
        border: 1px solid #ccc;
        border-top: 0;
      }
      /* Dropdown Button */
      .dropbtn {
        background-color: #53825b;
        color: white;
        /* padding: 16px; */
        /* font-size: 16px; */
        border: none;
        cursor: pointer;
      }
      /* Dropdown button on hover & focus */
      /* .dropbtn:hover,
      .dropbtn:focus {
        background-color: rgb(156, 68, 73);
      } */
      /* The container <div> - needed to position the dropdown content */
      .dropdown {
        position: relative;
        display: inline-block;
      }
      /* Dropdown Content (Hidden by Default) */
      .dropdown-content {
        display: none;
        position: absolute;
        background-color: #f1f1f1;
        min-width: 160px;
        box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
        z-index: 1;
      }
      /* Links inside the dropdown */
      .dropdown-content a {
        color: black;
        padding: 12px 16px;
        text-decoration: none;
        display: block;
      }
      /* Change color of dropdown links on hover */
      .dropdown-content a:hover {
        background-color: #ddd;
      }
      /* Show the dropdown menu (use JS to add this class to the .dropdown-content container when the user clicks on the dropdown button) */
      .show {
        display: block;
      }
    </style>
  </head>
  <body>
    <div id="map">
      <div id="legend">
        <h2>Opportunities</h2>
        <p>Stage</p>
        <ul class="opportunities" id="opportunities-list"></ul>
        <hr />
        <div class="add-contact-container" id="add-contact">
          <img
            src="https://geografa.github.io/portfolio/img/add-button.png"
            alt="add button"
          />
          <span class="add-contact">New Lead</span>
        </div>
        <!-- comment out below in prod -->
        <div id="coord-input-container">
          <div id="gps-coords"></div>
          <!-- end -->
        </div>
      </div>
    </div>

    <script>
      mapboxgl.accessToken =
        "pk.eyJ1IjoiZ3JhZmEiLCJhIjoiY2ptYjNtZWxnMDBrdDNwbnVicGJzOWg2NyJ9.9OulyCe3kEqMAXPbx1mKUA";
      const map = new mapboxgl.Map({
        container: "map",
        // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
        style: "mapbox://styles/grafa/cm6h1ok55008g01re2fbd47ks",
        center: [-122.265587, 37.487199],
        zoom: 9,
        bearing: 0,
        pitch: 0,
      });

      const url = "https://services.leadconnectorhq.com/contacts/search";
      const options = {
        method: "POST",
        headers: {
          Authorization: "Bearer pit-b9abe7c9-a76c-4e6d-b8c3-4d4777ebff10",
          Version: "2021-07-28",
          "Content-Type": "application/json",
          Accept: "application/json",
        },
      };

      async function fetchContactsData(page = 1, pageLimit = 100) {
        const requestBody = {
          locationId: "vmVbiiFxcFwGxrxjotMf",
          page: page,
          pageLimit: pageLimit,
          sort: [{ field: "firstNameLowerCase", direction: "desc" }],
        };

        options.body = JSON.stringify(requestBody);

        try {
          const response = await fetch(url, options);
          const data = await response.json();
          return data.contacts;
        } catch (error) {
          console.error("Error fetching contacts data:", error);
        }
      }

      async function fetchAllContacts() {
        let allContacts = [];
        let page = 1;
        let pageLimit = 100;
        let hasMorePages = true;

        while (hasMorePages) {
          const contacts = await fetchContactsData(page, pageLimit);
          if (contacts.length > 0) {
            allContacts = allContacts.concat(contacts);
            page++;
          } else {
            hasMorePages = false;
          }
        }
        // console.log("allContacts", allContacts);
        return allContacts;
      }

      const stageColors = {
        new_lead_found: "#a7d3a8",
        new_lead_inquiry: "#19a447",
        demo: "#ec6157",
        contacted_lead: "#bada55",
        contacted_decision_maker: "#32742C",
        unable_to_contact_lead: "#94b1c6",
        no_show: "#E54028",
        canceled: "#cf1431",
        demo_set: "#2EA7C9",
        showed: "#3886bd",
        not_interested_not_yet_ready: "#e0dccb",
        quote_requested: "#f8b552",
        quote_sent: "#f8b552",
        unqualified_not_a_good_fit: "#f8b552",
        sold: "#ecbe13",
        // Add more mappings as needed
      };
      async function fetchOpportunities() {
        const pipelinesURL =
          "https://services.leadconnectorhq.com/opportunities/pipelines?locationId=vmVbiiFxcFwGxrxjotMf";
        const pipelinesOptions = {
          method: "GET",
          headers: {
            Authorization: "Bearer pit-b9abe7c9-a76c-4e6d-b8c3-4d4777ebff10",
            Version: "2021-07-28",
            Accept: "application/json",
          },
        };
        try {
          const response = await fetch(pipelinesURL, pipelinesOptions);
          const data = await response.json();
          const opportunities = data.pipelines[6].stages.map((stage) => {
            // convert name to lowercase and replace all the spaces with dashes
            stage.layerId = stage.name.toLowerCase().replace(/\s/g, "_");
            // Set the color based on the layer name
            const color = stageColors[stage.layerId] || "#000000"; // Default to black if not found
            console.log("stage", stage);
            return {
              id: stage.id,
              name: stage.name,
              position: stage.position,
              color: color,
              layerId: stage.layerId,
            };
          });
          const opportunitiesList =
            document.getElementById("opportunities-list");
          opportunities.forEach((opportunity, index) => {
            // console.log("opportunity", opportunity);
            // only show the opportunities in a certain position from Smash Leads Pipeline https://app.theleadtoolbox.com/v2/location/vmVbiiFxcFwGxrxjotMf/opportunities/pipeline
            const showPosition = [0, 1, 3, 6, 7, 8, 9, 10, 11, 16];
            if (!showPosition.includes(opportunity.position)) {
              return;
            }
            const li = document.createElement("li");
            li.innerHTML = `
                        <label class="switch">
                        <input type="checkbox" id="opportunity-${index}" checked/>
                        <span class="slider round"></span>
                        </label>
                        ${opportunity.name}
                    `;
            opportunitiesList.appendChild(li);
            // Add event listener to change color when checked
            const checkbox = li.querySelector(`#opportunity-${index}`);
            // initialize the slider color to the opportunity color
            const slider = checkbox.nextElementSibling;
            slider.style.backgroundColor = opportunity.color;
            checkbox.addEventListener("change", (event) => {
              // const slider = event.target.nextElementSibling;
              if (event.target.checked) {
                slider.style.backgroundColor = opportunity.color;
                map.setLayoutProperty(
                  opportunity.layerId,
                  "visibility",
                  "visible"
                );
              } else {
                slider.style.backgroundColor = "#ccc";
                map.setLayoutProperty(
                  opportunity.layerId,
                  "visibility",
                  "none"
                );
              }
            });
          });
          return opportunities;
        } catch (error) {
          console.error("Error fetching pipelines:", error);
        }
      }

      // Fetch all contacts and add them to the map
      async function initializeMap() {
        map.addControl(new mapboxgl.NavigationControl());
        map.addControl(
          new mapboxgl.GeolocateControl({
            positionOptions: { enableHighAccuracy: true },
            trackUserLocation: true,
          })
        );

        map.on("load", async () => {
          const allContacts = await fetchAllContacts();
          const pipelines = await fetchOpportunities();

          // Filter contacts to only those with opportunities
          const contactsWithOpportunities = allContacts.filter(
            (contact) =>
              contact.opportunities && contact.opportunities.length > 0
          );

          // console.log(
          //   `Found ${contactsWithOpportunities.length} contacts with opportunities`
          // );

          const featureCollection = {
            type: "FeatureCollection",
            features: [],
          };

          contactsWithOpportunities.forEach((contact) => {
            const coordinates = contact.customFields.find(
              (field) => field.id === "VyePc8cM7iupVOBiZBHY"
            );
            const stageId = contact.opportunities[0]?.pipelineStageId;
            const stage = pipelines.find((stage) => stage.id === stageId);

            if (coordinates?.value && stage) {
              const [lng, lat] = coordinates.value.split(",").map(Number);

              // Only add feature if coordinates are valid numbers
              if (!isNaN(lng) && !isNaN(lat)) {
                featureCollection.features.push({
                  type: "Feature",
                  geometry: {
                    type: "Point",
                    coordinates: [lng, lat],
                  },
                  properties: {
                    title: `${contact.firstNameLowerCase} ${contact.lastNameLowerCase}`,
                    stage: stage.name,
                    layerId: stage.layerId,
                    stageColor: stage.color,
                  },
                });
              }
            }
          });

          map.addSource("contacts", {
            type: "geojson",
            data: featureCollection,
          });

          // Add a layer for each stage
          pipelines.forEach((stage) => {
            map.addLayer({
              id: stage.layerId,
              type: "circle",
              source: "contacts",
              paint: {
                "circle-radius": 8,
                "circle-color": stage.color,
                "circle-stroke-width": 1,
                "circle-stroke-color": "#ffffff",
              },
              filter: ["==", ["get", "layerId"], stage.layerId],
            });
          });
        });
      }

      initializeMap();

      const popup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: true,
      });
      map.on("click", (e) => {
        const features = map.queryRenderedFeatures(e.point, {
          layers: [
            "new_lead_found",
            "new_lead_inquiry",
            // "contacted_lead",
            "unable_to_contact_lead",
            "contacted_decision_maker",
            "canceled",
            // Add more layers as needed
          ],
        });

        if (!features.length) {
          return;
        }

        const feature = features[0];
        // if the layer clicked matches the color of the stage, show the dropbtn with the stage name and same color
        popup.setLngLat(feature.geometry.coordinates).setHTML(`
              <h3>${feature.properties.title}</h3>
              <div class="dropdown">
                <button onclick="changeStage()" class="dropbtn" style="background-color: ${
                  stageColors[feature.layer.id]
                }">${feature.properties.stage}</button>
                <div id="stageMenu" class="dropdown-content">
                  <a href="#">New Lead Found</a>
                  <a href="#">New Lead Inquiry</a>
                  <a href="#">Contacted</a>
                  <a href="#">Demo</a>
                  <a href="#">Closed</a>
                </div>
              </div>
            `); // add more stages as needed

        popup.addTo(map);
        //   Close the dropdown menu if the user clicks outside of it
        window.onclick = function (event) {
          if (!event.target.matches(".dropbtn")) {
            var dropdowns = document.getElementsByClassName("dropdown-content");
            var i;
            for (i = 0; i < dropdowns.length; i++) {
              var openDropdown = dropdowns[i];
              if (openDropdown.classList.contains("show")) {
                openDropdown.classList.remove("show");
              }
            }
          }
        };
      });
      function changeStage() {
        // add event listener to the button to toggle the dropdown content when clicked
        document.getElementById("stageMenu").classList.toggle("show");
      }
      // Add a new contact when the New Lead button is clicked
      let marker;

      document.getElementById("add-contact").addEventListener("click", () => {
        // Remove existing marker if it exists
        if (marker) {
          marker.remove();
        }
        // Create a custom HTML element for the marker
        const el = document.createElement("div");
        el.className = "custom-marker";
        // Add a new draggable marker to the map
        marker = new mapboxgl.Marker({
          draggable: true,
          element: el,
        })
          .setLngLat(map.getCenter())
          .addTo(map);

        // Update the input field with the marker's coordinates
        const updateCoords = () => {
          const lngLat = marker.getLngLat();
          const coords = lngLat.lng.toFixed(6) + ", " + lngLat.lat.toFixed(6);

          // update div ID to "VyePc8cM7iupVOBiZBHY" in production

          // Update the coordinates in the div with the ID "gps-coords"
          document.getElementById("gps-coords").textContent = // fixed to 6 decimal places
            lngLat.lng.toFixed(6) + ", " + lngLat.lat.toFixed(6);
          // Dispatch an input event to update the form field
          console.log("lngLat", lngLat);
          document
            .getElementById("gps-coords")
            .dispatchEvent(new Event("input"));
          //   document.getElementById("VyePc8cM7iupVOBiZBHY").value = coords;
        };

        // Initial update of the coordinates
        updateCoords();

        // Update the coordinates when the marker is dragged
        marker.on("dragend", updateCoords);
      });
    </script>
  </body>
</html>
