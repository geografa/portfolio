<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Pearl District, San Antonio</title>
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v3.9.3/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.9.3/mapbox-gl.js"></script>
    <!-- Load the `mapbox-gl-geocoder` plugin. -->
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.min.js"></script>
    <link
      rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.3/mapbox-gl-geocoder.css"
      type="text/css"
    />
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }

      .modal {
        font-family: "Popins", sans-serif;
        /* display: none; */
        position: fixed;
        z-index: 1;
        bottom: 0;
        /* round the top corners */
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        width: 100%;
        height: 400px;
        overflow: auto;
        background-image: url("https://media.mapme.com/places/72d09a64-fb52-4aa8-91e8-6e7a191d2429/gallery/c1005c39-7ce7-4c0d-9236-ba038c8ada97.hd"),
          linear-gradient(
            to bottom,
            rgba(255, 255, 255, 1),
            rgba(255, 255, 255, 0.95),
            rgba(255, 255, 255, 0.65)
          );
        background-size: cover;
        background-blend-mode: overlay;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2),
          0 6px 20px 0 rgba(0, 0, 0, 0.19);
      }
      .hidden {
        /* transfomr the modal to be lower */
        transform: translateY(280px);
      }
      .modal-header {
        display: block;
        /* justify-content: space-between; */
        padding: 20px;
      }

      .modal-header img {
        width: 20%;
        height: auto;
      }
      .modal-header h2 {
        margin-bottom: 0;
        color: rgb(182, 73, 0);
      }
      .modal-header h3 {
        font-size: 1rem;
        font-weight: 400;
        color: rgb(94, 94, 94);
        margin-top: 8px;
      }
      .modal-header .duration {
        display: inline-block;
        width: 30px;
        height: 30px;
        background-color: #b64900;
        color: white;
        border-radius: 50%;
        text-align: center;
        line-height: 30px;
        font-size: 1rem;
      }
      .modal-content {
        display: flex;
        align-items: flex-start;
        flex-direction: row;
        padding: 10px;
        font-family: "Popins", sans-serif;
        padding-left: 20px;
      }

      .modal-content p {
        padding: 10px;
        font-size: 1rem;
        font-weight: 200;
        line-height: 1.5;
        color: rgb(94, 94, 94);
      }
      .close-modal {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
        width: 16px;
      }
      .open-modal {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
        width: 16px;
      }
      .directions-link {
        /* display: none; */
        cursor: pointer;
        color: rgb(182, 73, 0);
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div id="modal" class="modal">
      <div id="closemodal">
        <img
          src="https://geografa.github.io/portfolio/img/closemenu.png"
          alt="close menu"
          class="close-modal"
        />
      </div>
      <div class="modal-header">
        <!-- place details -->
        <div class="place-details">
          <!-- Use variable for heading <h2>Cured</h2> -->
          <h2>The Pearl</h2>
        </div>
      </div>
      <div class="modal-content"></div>
    </div>

    <div id="map"></div>
    <script>
      mapboxgl.accessToken =
        "pk.eyJ1IjoiZ3JhZmEiLCJhIjoiY2ptYjNtZWxnMDBrdDNwbnVicGJzOWg2NyJ9.9OulyCe3kEqMAXPbx1mKUA";

      const start_cured = [-98.47996783687654, 29.441887287342766];
      const start_bottling = [-98.4808014337685, 29.44199890225623];
      const start_cellar = [-98.48100799, 29.44213212];

      const map = (window.map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/grafa/cm4noofna009j01s5gji15azp",
        center: [-98.480747, 29.442041],
        zoom: 17,
        bearing: 13,
        pitch: 45,
        minZoom: 16,
        // maxZoom: 19.5,
        projection: "mercator",
        // hash: true,
      }));

      // fetch trees from ./data/san_antonio_trees.geojson
      const getTrees = async () => {
        const response = await fetch("./data/san_antonio_trees.geojson");
        const data = await response.json();
        return data;
      };
      const getLocations = async () => {
        const response = await fetch("./data/pearl_locations.geojson");
        const data = await response.json();
        return data;
      };

      let coords;

      const route = {
        type: "FeatureCollection",
        features: [
          {
            type: "Feature",
            properties: {},
            geometry: coords,
          },
        ],
      };

      // add geolocaation control to the map
      const geolocate = new mapboxgl.GeolocateControl({
        positionOptions: {
          enableHighAccuracy: true,
        },
        trackUserLocation: true,
      });
      map.addControl(geolocate, "top-right");

      let customData;

      const fetchCustomData = () => {
        return fetch("./data/pearl_locations.geojson")
          .then((response) => response.json())
          .then((data) => {
            customData = data;
          });
      };

      function forwardGeocoder(query) {
        const matchingFeatures = [];
        for (const feature of customData.features) {
          // Handle queries with different capitalization
          // than the source data by calling toLowerCase().
          if (
            feature.properties.title.toLowerCase().includes(query.toLowerCase())
          ) {
            feature["place_name"] = `ðŸ”µ ${feature.properties.title}`;
            feature.center = feature.geometry.coordinates;
            feature.place_type = ["poi"];
            matchingFeatures.push(feature);
            console.log(matchingFeatures);
          }
        }
        return matchingFeatures;
      }
      let start;

      geolocate.on("geolocate", (e) => {
        start = [e.coords.longitude, e.coords.latitude];
        // set the initial map position to the center:[-98.479825,29.442216],
        // zoom:17,
        // bearing:-80,
        // pitch:41,
        map.flyTo({
          center: [-98.479825, 29.442216],
          zoom: 17,
          bearing: -80,
          pitch: 41,
          essential: true,
        });
      });
      // Define the getDirections function
      async function getDirections(start, end) {
        const query = await fetch(
          `https://api.mapbox.com/directions/v5/mapbox/walking/${start[0]},${start[1]};${end[0]},${end[1]}?steps=true&overview=full&geometries=geojson&access_token=${mapboxgl.accessToken}`,
          { method: "GET" }
        );
        const json = await query.json();
        const data = json.routes[0];
        let route = data.geometry.coordinates;

        let geojson = {
          type: "Feature",
          properties: {},
          geometry: {
            type: "LineString",
            coordinates: route,
          },
        };

        // If the route source already exists, update it
        if (map.getSource("route")) {
          map.getSource("route").setData(geojson);
        } else {
          // Otherwise, add a new source and layer for the route
          map.addSource("route", {
            type: "geojson",
            data: geojson,
          });

          map.addLayer({
            id: "route",
            type: "line",
            source: "route",
            layout: {
              "line-join": "round",
              "line-cap": "round",
            },
            paint: {
              "line-color": "#3887be",
              "line-width": 5,
              "line-opacity": 0.75,
              // dash line effect
              "line-dasharray": [2, 2],
            },
            slot: "bottom",
          });
          // get the bounds of the geojson route and fit the map to it
          const bounds = route.reduce(function (bounds, coord) {
            return bounds.extend(coord);
          }, new mapboxgl.LngLatBounds(route[0], route[0]));
          map.fitBounds(bounds, {
            padding: 20,
          });
        }
        // add the duration and distance to the modal content
        document.querySelector(
          ".modal-header"
        ).innerHTML += `<br><p class="duration" >${Math.floor(
          data.duration / 60
        )}</p> minute(s) away`;
        // move the modal lower by adding the hidden class
        document.querySelector(".modal").classList.add("hidden");
      }

      fetchCustomData().then(() => {
        map.addControl(
          new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            localGeocoder: forwardGeocoder,
            zoom: 14,
            placeholder: "Enter search e.g. Hotel Emma",
            mapboxgl: mapboxgl,
            // keep to the bounds of san antonio tx
            bbox: [-98.7, 29.2, -98.2, 29.7],
          }),
          "top-left"
        );
      });

      map.on("load", () => {
        // add the trees as a source to the map
        getTrees().then((data) => {
          map.addModel("model-conifer", "./models/tree-conifer.glb");
          map.addModel("model-deciduous", "./models/tree-deciduous.glb");
          map.addSource("trees", {
            type: "geojson",
            data: data,
          });

          // add a layer for the trees
          map.addLayer({
            id: "trees",
            type: "model",
            source: "trees",
            layout: {
              "model-id": "model-deciduous",
              // [
              //   "match",
              //   ["get", "FUNCTIONAL_TYPE"],
              //   "Broadleaf deciduous",
              //   "model-deciduous",
              //   "Coniferous evergreen",
              //   "model-conifer",
              //   "model-conifer",
              // ],
            },
            slot: "middle",
          });
        });
        // set the light preset to be in dusk mode.
        map.setConfigProperty("basemap", "lightPreset", "day");

        // add a geojson source with a polygon to be used in the clip layer.
        map.addSource("eraser", {
          type: "geojson",
          data: {
            type: "FeatureCollection",
            features: [
              {
                type: "Feature",
                properties: {},
                geometry: {
                  coordinates: [
                    [
                      [-98.47977856402079, 29.44208036225737],
                      [-98.4799360112728, 29.442083649223036],
                      [-98.47996728504165, 29.44204702303108],
                      [-98.47997699069445, 29.442004762023814],
                      [-98.479997480405, 29.441877039761224],
                      [-98.47983949395054, 29.441839004791177],
                      [-98.47976939757156, 29.442020257728302],
                      [-98.47977856402079, 29.44208036225737],
                    ],
                  ],
                  type: "Polygon",
                },
              },
              {
                type: "Feature",
                properties: {},
                geometry: {
                  coordinates: [
                    [
                      [-98.4808388967579, 29.44203613425634],
                      [-98.4808388967579, 29.441779220077038],
                      [-98.48037561568647, 29.441779220077038],
                      [-98.48037561568647, 29.44203613425634],
                      [-98.4808388967579, 29.44203613425634],
                    ],
                  ],
                  type: "Polygon",
                },
              },
            ],
          },
        });

        // add a geojson source which specifies the custom model to be used by the model layer.
        map.addSource("source-cured", {
          type: "geojson",
          data: {
            type: "Feature",
            properties: {
              "model-uri":
                // "http://localhost:8080/models/bottling_dept_centered.glb",
                "https://geografa.github.io/portfolio/models/pearl_cured.glb",
            },
            geometry: {
              type: "Point",
              coordinates: start_cured,
            },
          },
        });
        map.addSource("source-bottling", {
          type: "geojson",
          data: {
            type: "Feature",
            properties: {
              "model-uri":
                // "http://localhost:8080/models/pearl_bottling_dept.glb",
                "https://geografa.github.io/portfolio/models/pearl_bottling_dept.glb",
            },
            geometry: {
              type: "Point",
              coordinates: start_bottling,
            },
          },
        });
        map.addSource("source-cellar", {
          type: "geojson",
          data: {
            type: "Feature",
            properties: {
              "model-uri":
                // "http://localhost:8080/models/pearl_bottling_dept.glb",
                "https://geografa.github.io/portfolio/models/pearl_sign.glb",
            },
            geometry: {
              type: "Point",
              coordinates: start_cellar,
            },
          },
        });

        // add the clip layer and configure it to also remove symbols and trees.
        // `clip-layer-scope` layout property is used to specify that only models from the Mapbox Standard Style should be clipped.
        // this will prevent the newly added model from getting clipped.
        map.addLayer({
          id: "eraser",
          type: "clip",
          source: "eraser",
          layout: {
            // specify the layer types to be removed by this clip layer
            "clip-layer-types": ["symbol", "model"],
            "clip-layer-scope": ["basemap"],
          },
        });

        // add the model layer and specify the appropriate `slot` to ensure the symbols are rendered correctly.

        map.addLayer({
          id: "layer-cured",
          type: "model",
          source: "source-cured",
          layout: {
            "model-id": ["get", "model-uri"],
          },
          paint: {
            "model-color-mix-intensity": 0.1,
            "model-color": "rgba(0,0, 0, 1)",
            "model-scale": [1, 1, 1],
            "model-rotation": [0, 0, 11],
          },
        });
        map.addLayer({
          id: "layer-bottling",
          type: "model",
          source: "source-bottling",
          layout: {
            "model-id": ["get", "model-uri"],
          },
          paint: {
            "model-color-mix-intensity": 0.1,
            "model-color": "rgba(0,0, 0, 1)",
            "model-scale": [1, 1, 1],
            "model-rotation": [0, 0, 0],
          },
        });
        map.addLayer({
          id: "layer-cellar",
          type: "model",
          source: "source-cellar",
          layout: {
            "model-id": ["get", "model-uri"],
          },
          paint: {
            "model-color-mix-intensity": 0,
            "model-color": "rgba(0,0, 0, 1)",
            "model-scale": [1.2, 1.2, 1.2],
            "model-rotation": [0, 0, 278],
            "model-opacity": 1,
          },
        });
        // add the pearl locations to the map as a source and layer
        getLocations().then((data) => {
          map.addSource("pearl-locations", {
            type: "geojson",
            data: data,
          });
          map.addLayer({
            id: "pearl-locations",
            type: "symbol",
            source: "pearl-locations",
            layout: {
              "icon-image": "mapbox-heart",
              "icon-size": 0.7,
              "icon-allow-overlap": true,
              "text-field": ["get", "title"],
              "text-font": ["Open Sans Bold", "Arial Unicode MS Bold"],
              "text-size": 12,
              "text-offset": [0, 1.5],
              "text-anchor": "top",
            },
            paint: {
              "text-color": "rgba(0,0,0,1)",
              "text-halo-color": "rgba(255,255,255,1)",
              "text-halo-width": 1,
            },
          });
        });
        map.addSource("route", {
          type: "geojson",
          data: route,
        });

        map.addLayer({
          id: "route",
          type: "line",
          source: "route",
          layout: {
            "line-join": "round",
            "line-cap": "round",
          },
          paint: {
            "line-color": "#0d5bc1",
            "line-width": 12,
            "line-opacity": 0.7,
            // dash line effect
            // make the line dash so the dashes look like circles
            "line-dasharray": [0.02, 1.6],
            "line-occlusion-opacity": 0.25,
          },
          slot: "middle",
        });
      });

      const popup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: true,
      });

      map.on("click", (e) => {
        // Set `bbox` as 5px reactangle area around clicked point.
        const bbox = [
          [e.point.x - 5, e.point.y - 5],
          [e.point.x + 5, e.point.y + 5],
        ];

        // Find features intersecting the bounding box.
        const selectedFeatures = map.queryRenderedFeatures(bbox, {
          layers: ["pearl-locations"],
        });
        if (selectedFeatures.length > 0) {
          const feature = selectedFeatures[0];
          const detailsImg = feature.properties.image;
          const details =
            "<h2>" +
            feature.properties.title +
            "</h2>" +
            "<h3>" +
            feature.properties.heading +
            "</h3><a href='#' class='directions-link'>" +
            feature.properties.address +
            "</a>";
          const featureCoordinates = feature.geometry.coordinates.slice();
          // add place details to the place-details div in the modal
          document.querySelector(".modal-header").innerHTML = `${details}`;
          document.querySelector(
            ".modal-content"
          ).innerHTML = `<p>${feature.properties.description}</p>`;
          // change the background of the modal to the image of the place and the same gradients
          document.querySelector(
            ".modal"
          ).style.backgroundImage = `url(${detailsImg}), linear-gradient(to bottom, rgba(255, 255, 255, 1), rgba(255, 255, 255, 0.65))`;

          // listen for the click event on the directions link and call the getDirections function
          // get the start location from the geolocate control if it is set or use the default start location
          document
            .querySelector(".directions-link")
            .addEventListener("click", () => {
              if (start) {
                getDirections(start, featureCoordinates);
              } else {
                getDirections([-98.479825, 29.442216], featureCoordinates);
              }
            });
        }
      });

      // if the modal already has the class hidden, remove it and show the modal else add the hidden class to the modal when clicking the close button
      document.querySelector(".close-modal").addEventListener("click", () => {
        if (document.querySelector(".modal").classList.contains("hidden")) {
          document.querySelector(".modal").classList.remove("hidden");
        } else {
          document.querySelector(".modal").classList.add("hidden");
        }
      });
    </script>
  </body>
</html>
